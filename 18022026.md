Добавим функционал добавления спортсмена в категорию на соревнованиях. Это включает обновление страницы управления спортсменами, чтобы можно было выбрать турнир и категорию при регистрации.

1. Обновление страницы participants.html

Добавим выбор турнира и категории в форму добавления спортсмена:

```html
<!-- В блоке participants-actions, внутри формы addAthleteForm, после полей спортсмена -->

<div class="form-group">
    <label class="form-label">Турнир *</label>
    <select class="form-control" id="tournamentSelect" required>
        <option value="">Выберите турнир</option>
        <!-- Загружается через JavaScript -->
    </select>
</div>

<div class="form-group">
    <label class="form-label">Категория</label>
    <select class="form-control" id="categorySelect">
        <option value="">Без категории</option>
        <!-- Загружается через JavaScript -->
    </select>
</div>

<div class="form-group">
    <label class="form-label">Посев (необязательно)</label>
    <input type="number" class="form-control" id="participantSeed" min="1" placeholder="Номер посева">
</div>
```

2. JavaScript для загрузки турниров и категорий

Добавьте в participants.html после существующего скрипта:

```javascript
// Загрузка активных турниров для выбора
async function loadTournamentsForSelect() {
    try {
        const response = await fetch('/api/tournaments?status=active');
        const tournaments = await response.json();
        
        const select = document.getElementById('tournamentSelect');
        select.innerHTML = '<option value="">Выберите турнир</option>';
        
        tournaments.forEach(t => {
            const option = document.createElement('option');
            option.value = t.id;
            option.textContent = `${t.name} (${t.tournament_type === 'olympic' ? 'Олимпийская' : 'Оценки'})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Ошибка загрузки турниров:', error);
    }
}

// Загрузка категорий при выборе турнира
document.getElementById('tournamentSelect').addEventListener('change', async function() {
    const tournamentId = this.value;
    const categorySelect = document.getElementById('categorySelect');
    
    if (!tournamentId) {
        categorySelect.innerHTML = '<option value="">Без категории</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/tournaments/${tournamentId}/categories`);
        const categories = await response.json();
        
        categorySelect.innerHTML = '<option value="">Без категории</option>';
        categories.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            
            // Формируем описание категории
            let desc = c.name;
            if (c.weight_min || c.weight_max) {
                desc += ` (вес: ${c.weight_min || 0}-${c.weight_max || '∞'} кг)`;
            }
            if (c.age_min || c.age_max) {
                desc += ` (возраст: ${c.age_min || 0}-${c.age_max || '∞'})`;
            }
            if (c.gender) {
                const genderMap = {male: '♂', female: '♀', mixed: '⚥'};
                desc += ` ${genderMap[c.gender] || ''}`;
            }
            
            option.textContent = desc;
            categorySelect.appendChild(option);
        });
    } catch (error) {
        console.error('Ошибка загрузки категорий:', error);
    }
});

// Обновлённая функция добавления спортсмена
document.getElementById('addAthleteForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const tournamentId = document.getElementById('tournamentSelect').value;
    if (!tournamentId) {
        alert('Выберите турнир');
        return;
    }
    
    const formData = {
        tournament_id: parseInt(tournamentId),
        category_id: document.getElementById('categorySelect').value || null,
        first_name: document.getElementById('firstName').value,
        last_name: document.getElementById('lastName').value,
        birth_date: document.getElementById('birthDate').value || null,
        gender: document.getElementById('gender').value || null,
        weight: parseFloat(document.getElementById('weight').value) || null,
        height: parseFloat(document.getElementById('height').value) || null,
        country: document.getElementById('country').value || null,
        club: document.getElementById('club').value || null,
        coach: document.getElementById('coach').value || null,
        license_number: document.getElementById('licenseNumber').value || null,
        photo_url: document.getElementById('photoUrl').value || null,
        seed: parseInt(document.getElementById('participantSeed').value) || null
    };
    
    try {
        const response = await fetch('/api/participants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            alert('Спортсмен успешно добавлен в турнир');
            this.reset();
            loadTournamentsForSelect(); // перезагрузить список турниров
            // можно также обновить список спортсменов
        } else {
            const err = await response.json();
            alert('Ошибка: ' + (err.message || 'Не удалось добавить спортсмена'));
        }
    } catch (error) {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при добавлении спортсмена');
    }
});

// Вызвать загрузку турниров при загрузке страницы
loadTournamentsForSelect();
```

3. Обновление API в app.py для обработки POST /api/participants

Убедитесь, что эндпоинт создания участника корректно обрабатывает данные и создаёт/связывает спортсмена:

```python
@app.route('/api/participants', methods=['POST'])
def create_participant():
    data = request.json
    
    # Проверить существование спортсмена по имени и дате рождения
    athlete = Athlete.query.filter_by(
        first_name=data['first_name'],
        last_name=data['last_name'],
        birth_date=data.get('birth_date')
    ).first()
    
    if not athlete:
        # Создать нового спортсмена
        athlete = Athlete(
            first_name=data['first_name'],
            last_name=data['last_name'],
            birth_date=data.get('birth_date'),
            gender=data.get('gender'),
            weight=data.get('weight'),
            height=data.get('height'),
            country=data.get('country'),
            club=data.get('club'),
            coach=data.get('coach'),
            license_number=data.get('license_number'),
            photo_url=data.get('photo_url')
        )
        db.session.add(athlete)
        db.session.commit()
    
    # Проверить, не зарегистрирован ли уже спортсмен в этом турнире
    existing = Participant.query.filter_by(
        tournament_id=data['tournament_id'],
        athlete_id=athlete.id
    ).first()
    
    if existing:
        return jsonify({'error': 'Спортсмен уже зарегистрирован в этом турнире'}), 400
    
    # Создать участника турнира
    participant = Participant(
        tournament_id=data['tournament_id'],
        category_id=data.get('category_id'),
        athlete_id=athlete.id,
        seed=data.get('seed'),
        status='registered'
    )
    
    db.session.add(participant)
    db.session.commit()
    
    return jsonify(participant.to_dict()), 201
```

4. Добавление маршрута для просмотра участников по категориям

Если нужно видеть всех спортсменов, разбитых по категориям, добавьте:

```python
@app.route('/api/tournaments/<int:tournament_id>/participants-by-category')
def participants_by_category(tournament_id):
    categories = Category.query.filter_by(tournament_id=tournament_id).all()
    result = []
    for cat in categories:
        participants = Participant.query.filter_by(category_id=cat.id).all()
        result.append({
            'category_id': cat.id,
            'category_name': cat.name,
            'participants': [p.to_dict() for p in participants]
        })
    # Также участники без категории
    uncategorized = Participant.query.filter_by(tournament_id=tournament_id, category_id=None).all()
    if uncategorized:
        result.append({
            'category_id': None,
            'category_name': 'Без категории',
            'participants': [p.to_dict() for p in uncategorized]
        })
    return jsonify(result)
```

5. Дополнительно: страница управления участниками в категории

Если нужно отдельное представление, создайте шаблон templates/category_participants.html (уже описан ранее) и маршрут:

```python
@app.route('/category/<int:category_id>/participants')
def view_category_participants(category_id):
    category = Category.query.get_or_404(category_id)
    participants = Participant.query.filter_by(category_id=category_id).all()
    return render_template('category_participants.html', 
                         category=category,
                         participants=participants)
```

Теперь можно добавлять спортсменов сразу в конкретную категорию выбранного турнира.
